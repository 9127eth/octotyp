<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OctoTyp</title>
    <style>
        :root {
            --background-color: #f5f5f7;
            --text-color: #1d1d1f;
            --accent-color: #0071e3;
            --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.5;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            padding-top: 20px; /* Adjusted padding to bring content closer to the top */
        }

        h1 {
            text-align: left;
            margin-bottom: 30px;
            padding-left: 20px;
            margin-top: 0;
        }

        .tweet-box {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
            transition: box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .tweet-box:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        textarea {
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 12px; /* Increased border-radius for more rounded corners */
            resize: vertical;
            min-height: 100px;
            font-size: 16px;
            font-family: inherit;
            margin-bottom: 10px;
            padding: 12px 15px; /* Increased padding for text inside */
            box-sizing: border-box; /* Ensure padding doesn't affect overall width */
        }

        textarea::placeholder {
            color: #999;
        }

        .tweet-info {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .character-count {
            margin-right: 10px;
        }

        .thread-count {
            display: flex;
            align-items: center;
        }

        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 6px 12px; /* Reduced padding */
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
            display: inline-block; /* Changed from flex to inline-block */
        }

        button:hover {
            background-color: #005bbf;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .char-limit-control {
            display: flex;
            align-items: center;
        }

        #char-limit {
            width: 60px;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-left: 10px;
        }

        .tweet-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .tweet-controls-left {
            display: flex;
        }

        .tweet-controls-left button {
            margin-right: 10px;
        }

        .copy-btn {
            margin-left: auto;
        }

        .remove-btn {
            background-color: #ff4136; /* Red color for remove button */
            color: white;
        }

        .remove-btn:hover {
            background-color: #d0342b; /* Darker red on hover */
        }

        .move-controls {
            position: absolute;
            right: -40px;
            top: 0;
            display: flex;
            flex-direction: column;
        }

        .move-controls button {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            color: #333; /* Darker color for arrows in light mode */
        }

        /* Dark mode styles */
        body.dark-mode {
            --background-color: #1d1d1f;
            --text-color: #f5f5f7;
            --box-shadow: 0 2px 10px rgba(255, 255, 255, 0.1);
        }

        body.dark-mode .tweet-box {
            background-color: #2c2c2e;
        }

        body.dark-mode textarea {
            background-color: #2c2c2e;
            color: var(--text-color);
            border-color: #444; /* Darker border color for dark mode */
        }

        body.dark-mode .remove-btn {
            background-color: #c62828; /* Darker red for dark mode */
        }

        body.dark-mode .remove-btn:hover {
            background-color: #b71c1c; /* Even darker red on hover for dark mode */
        }

        body.dark-mode .move-controls button {
            color: #ccc; /* Lighter color for arrows in dark mode */
        }

        body.dark-mode .tweet-info {
            color: #999;
        }

        .modal {
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 400px; /* Reduced from 500px */
            border-radius: 10px;
            text-align: center;
        }

        .modal-content button {
            margin: 10px;
            font-size: 14px; /* Reduced font size */
            padding: 8px 16px; /* Adjusted padding */
        }

        #undo-btn {
            display: none;
            margin-left: 10px;
        }

        /* Dark mode styles for modal */
        body.dark-mode .modal-content {
            background-color: #2c2c2e;
            color: var(--text-color);
            border-color: #444;
        }

        .copy-confirm {
            margin-right: 10px;
            color: #28a745; /* Green color for confirmation */
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .copy-confirm.show {
            opacity: 1;
        }

        /* Dark mode styles */
        body.dark-mode .copy-confirm {
            color: #5cb85c; /* Lighter green for dark mode */
        }

        #combined-post {
            width: 100%;
            margin-bottom: 10px;
        }

        #combined-result .tweet-controls-right {
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        #combined-result .copy-confirm {
            margin-right: 10px;
        }

        /* Dark mode toggle switch styles */
        .dark-mode-toggle {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px; /* Reduced from 60px */
            height: 22px; /* Reduced from 34px */
            margin-left: 10px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 22px; /* Adjusted to match new height */
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px; /* Reduced from 26px */
            width: 18px; /* Reduced from 26px */
            left: 2px; /* Adjusted from 4px */
            bottom: 2px; /* Adjusted from 4px */
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--accent-color);
        }

        input:checked + .slider:before {
            transform: translateX(18px); /* Adjusted from 26px */
        }

        /* Dark mode styles for the toggle switch */
        body.dark-mode .slider {
            background-color: #555;
        }

        body.dark-mode .slider:before {
            background-color: #f5f5f7;
        }

        /* Apple-inspired authentication UI styles */
        #sign-up-form, #sign-in-form {
            max-width: 280px;
            margin: 20px auto;
            padding: 15px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #sign-up-form h2, #sign-in-form h2 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #1d1d1f;
        }

        #sign-up-form input, #sign-in-form input {
            width: calc(100% - 24px);
            margin-bottom: 8px;
            padding: 10px;
            border: 1px solid #d1d1d1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        #sign-up-form input:focus, #sign-in-form input:focus {
            outline: none;
            border-color: #0071e3;
        }

        #sign-up-form button, #sign-in-form button {
            width: 100%;
            background-color: #0071e3;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            padding: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-bottom: 8px;
        }

        #sign-up-form button:hover, #sign-in-form button:hover {
            background-color: #0077ed;
        }

        #sign-up-form button:active, #sign-in-form button:active {
            background-color: #006edb;
        }

        .google-btn {
            background-color: #ffffff !important;
            color: #1d1d1f !important;
            border: 1px solid #d1d1d1 !important;
        }

        .google-btn:hover {
            background-color: #f5f5f7 !important;
        }

        /* Dark mode styles for authentication UI */
        body.dark-mode #sign-up-form,
        body.dark-mode #sign-in-form {
            background-color: #1c1c1e;
        }

        body.dark-mode #sign-up-form h2,
        body.dark-mode #sign-in-form h2 {
            color: #f5f5f7;
        }

        body.dark-mode #sign-up-form input,
        body.dark-mode #sign-in-form input {
            background-color: #2c2c2e;
            border-color: #3a3a3c;
            color: #ffffff;
        }

        body.dark-mode #sign-up-form input:focus,
        body.dark-mode #sign-in-form input:focus {
            border-color: #0a84ff;
        }

        body.dark-mode #sign-up-form button,
        body.dark-mode #sign-in-form button {
            background-color: #0a84ff;
        }

        body.dark-mode #sign-up-form button:hover,
        body.dark-mode #sign-in-form button:hover {
            background-color: #0591ff;
        }

        body.dark-mode #sign-up-form button:active,
        body.dark-mode #sign-in-form button:active {
            background-color: #0082f0;
        }

        body.dark-mode .google-btn {
            background-color: #2c2c2e !important;
            color: #f5f5f7 !important;
            border-color: #3a3a3c !important;
        }

        body.dark-mode .google-btn:hover {
            background-color: #3a3a3c !important;
        }

        .error-message {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            font-size: 14px;
            padding: 8px;
            margin-bottom: 12px;
            display: none;
        }

        body.dark-mode .error-message {
            color: #f8d7da;
            background-color: #721c24;
            border-color: #9d2932;
        }

        .user-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        #user-info {
            font-size: 12px;
            background-color: #f5f5f7;
            padding: 5px 10px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            margin-bottom: 10px; /* Add margin to separate from dark mode toggle */
        }

        .dark-mode-toggle {
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .dark-mode-toggle label {
            margin-right: 10px;
            font-size: 14px;
        }

        #user-email {
            display: block;
            margin-bottom: 5px;
        }

        #sign-out-btn {
            font-size: 12px;
            padding: 4px 8px;
            background-color: #f5f5f7;
            color: #1d1d1f;
            border: 1px solid #d1d1d1;
            margin-bottom: 10px;
        }

        #sign-out-btn:hover {
            background-color: #e5e5e7;
        }

        /* Dark mode styles for user info */
        body.dark-mode #user-info {
            background-color: #2c2c2e;
        }

        body.dark-mode #sign-out-btn {
            background-color: #2c2c2e;
            color: #f5f5f7;
            border-color: #3a3a3c;
        }

        body.dark-mode #sign-out-btn:hover {
            background-color: #3a3a3c;
        }

        #auth-container {
            /* Remove any width, height, or positioning styles */
            margin: 20px auto;
            padding: 15px;
        }

        #forgot-password-form {
            max-width: 280px;
            margin: 20px auto;
            padding: 15px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
        }

        #forgot-password-form h2 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #1d1d1f;
        }

        #forgot-password-form input {
            width: calc(100% - 24px);
            margin-bottom: 8px;
            padding: 10px;
            border: 1px solid #d1d1d1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        #forgot-password-form input:focus {
            outline: none;
            border-color: #0071e3;
        }

        #forgot-password-form button {
            width: 100%;
            background-color: #0071e3;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            padding: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-bottom: 8px;
        }

        #forgot-password-form button:hover {
            background-color: #0077ed;
        }

        #forgot-password-form button:active {
            background-color: #006edb;
        }

        #forgot-password-form a {
            display: block;
            text-align: center;
            font-size: 14px;
            color: #0071e3;
            text-decoration: none;
        }

        #forgot-password-form a:hover {
            text-decoration: underline;
        }

        /* Dark mode styles for forgot password form */
        body.dark-mode #forgot-password-form {
            background-color: #1c1c1e;
        }

        body.dark-mode #forgot-password-form h2 {
            color: #f5f5f7;
        }

        body.dark-mode #forgot-password-form input {
            background-color: #2c2c2e;
            border-color: #3a3a3c;
            color: #ffffff;
        }

        body.dark-mode #forgot-password-form input:focus {
            border-color: #0a84ff;
        }

        body.dark-mode #forgot-password-form button {
            background-color: #0a84ff;
        }

        body.dark-mode #forgot-password-form button:hover {
            background-color: #0591ff;
        }

        body.dark-mode #forgot-password-form button:active {
            background-color: #0082f0;
        }

        body.dark-mode #forgot-password-form a {
            color: #0a84ff;
        }

        .forgot-password-link {
            display: block;
            text-align: center;
            font-size: 12px;
            color: #888;
            text-decoration: none;
            margin-top: 10px;
        }

        .forgot-password-link:hover {
            text-decoration: underline;
        }

        /* Dark mode styles for forgot password link */
        body.dark-mode .forgot-password-link {
            color: #aaa;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .url-checkbox {
            margin-left: 10px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
        }

        .url-checkbox input {
            margin-right: 5px;
        }

        .tooltip-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background-color: #888;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 16px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
            position: relative;
        }

        .tooltip-icon::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            text-align: center;
            z-index: 1;
            width: 200px;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip-icon:hover::after {
            visibility: visible;
            opacity: 1;
        }

        /* Dark mode styles for tooltip */
        body.dark-mode .tooltip-icon {
            background-color: #aaa;
            color: #1d1d1f;
        }

        body.dark-mode .tooltip-icon::after {
            background-color: #f5f5f7;
            color: #1d1d1f;
        }

        .twitter-btn {
            background-color: #1DA1F2 !important;
            color: #ffffff !important;
        }

        .twitter-btn:hover {
            background-color: #0c85d0 !important;
        }

        body.dark-mode .twitter-btn {
            background-color: #1A91DA !important;
        }

        body.dark-mode .twitter-btn:hover {
            background-color: #0c7abf !important;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 300px;
            border-radius: 10px;
            text-align: center;
        }

        .modal-content h3 {
            margin-top: 0;
        }

        .modal-content button {
            margin: 10px;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #confirm-delete-btn {
            background-color: #ff4136;
            color: white;
        }

        #cancel-delete-btn {
            background-color: #f0f0f0;
            color: #333;
        }

        /* Dark mode styles for the modal */
        body.dark-mode .modal-content {
            background-color: #2c2c2e;
            color: #f5f5f7;
            border-color: #444;
        }

        body.dark-mode #cancel-delete-btn {
            background-color: #3a3a3c;
            color: #f5f5f7;
        }

        .drafts-sidebar {
            width: 25%;
            padding-right: 20px;
        }

        .draft-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

        .draft-content {
            flex-grow: 1;
        }

        .draft-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .draft-date {
            font-size: 12px;
            color: #888;
        }

        .draft-actions {
            display: flex;
            gap: 10px;
        }

        .draft-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        .draft-actions button:hover {
            color: #0071e3;
        }

        .drafts-sidebar {
            width: 25%;
            padding-right: 20px;
        }

        .draft-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

        .draft-content {
            flex-grow: 1;
        }

        .draft-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .draft-date {
            font-size: 12px;
            color: #888;
        }

        .draft-actions {
            display: flex;
            gap: 10px;
        }

        .draft-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        .draft-actions button:hover {
            color: #0071e3;
        }

        .main-content {
            display: flex;
            flex-direction: row;
            align-items: flex-start; /* Align items to the top */
        }

        .drafts-sidebar {
            width: 25%;
            padding-right: 20px;
        }

        .draft-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

        .draft-content {
            flex-grow: 1;
        }

        .draft-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .draft-date {
            font-size: 12px;
            color: #888;
        }

        .draft-actions {
            display: flex;
            gap: 10px;
        }

        .draft-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        .draft-actions button:hover {
            color: #0071e3;
        }

        .post-section {
            width: 75%;
        }

        .error-message.success {
            color: #28a745;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
        }

        body.dark-mode .error-message.success {
            color: #d4edda;
            background-color: #28a745;
            border-color: #c3e6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="user-controls">
            <div id="user-info" style="display: none;">
                <span id="user-email"></span>
                <button id="sign-out-btn" onclick="handleSignOut()">Sign Out</button>
            </div>

            <div class="dark-mode-toggle">
                <label for="dark-mode-switch">Dark Mode</label>
                <label class="switch">
                    <input type="checkbox" id="dark-mode-switch" onchange="toggleDarkMode()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <h1>OctoTyp</h1>

        <div id="auth-error" class="error-message"></div>

        <div id="sign-up-form" style="display: none;">
            <h2>Sign Up</h2>
            <input type="email" id="sign-up-email" placeholder="Email" required>
            <input type="password" id="sign-up-password" placeholder="Password" required minlength="8">
            <button onclick="handleSignUp()">Sign Up</button>
            <button onclick="handleGoogleSignUp()" class="google-btn">Sign Up with Google</button>
            <button onclick="handleTwitterSignIn()" class="twitter-btn">Sign Up with Twitter</button>
        </div>
        <div id="sign-in-form" style="display: none;">
            <h2>Sign In</h2>
            <form onsubmit="handleSignIn(event)">
                <input type="email" id="sign-in-email" placeholder="Email" required>
                <input type="password" id="sign-in-password" placeholder="Password" required minlength="8">
                <button type="submit">Sign In</button>
                <button type="button" onclick="handleGoogleSignIn()" class="google-btn">Sign In with Google</button>
                <button type="button" onclick="handleTwitterSignIn()" class="twitter-btn">Sign In with Twitter</button>
            </form>
            <a href="#" onclick="showForgotPasswordForm()" class="forgot-password-link">Forgot Password?</a>
        </div>

        <div id="forgot-password-form" style="display: none;">
            <h2>Reset Password</h2>
            <input type="email" id="reset-email" placeholder="Email" required>
            <button onclick="handleForgotPassword()">Reset Password</button>
            <a href="#" onclick="showSignInForm()">Back to Sign In</a>
        </div>

        <div class="main-content">
            <div id="drafts-list" class="drafts-sidebar">
                <h2>Drafts</h2>
                <ul id="drafts-ul"></ul>
            </div>

            <div class="post-section">
                <div class="controls">
                    <div class="char-limit-control">
                        <label for="char-limit">Character Limit:</label>
                        <input type="number" id="char-limit" value="280">
                    </div>
                    <button id="create-new-btn" onclick="createNewDraft()">Create New</button>
                    <button id="save-draft-btn" onclick="saveDraftToFirestore()">Save Draft</button>
                </div>

                <div id="general-error" class="error-message"></div>

                <div id="tweet-thread" style="display: none;"></div>

                <button id="combine-tweets-btn" onclick="combinePosts()" style="display: none;">
                    Combine Posts
                </button>

                <div id="combined-result" style="display: none;">
                    <h3>Combined Post</h3>
                    <textarea id="combined-post" rows="10" oninput="autoResize(this)"></textarea>
                    <div class="tweet-controls-right">
                        <span class="copy-confirm">Copied!</span>
                        <button onclick="copyToClipboard('combined-post')">
                            Copy Combined Post
                        </button>
                    </div>
                </div>

                <div id="loading-indicator" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(255, 255, 255, 0.8); padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);">
                    <div class="spinner"></div>
                    <p>Loading...</p>
                </div>

                <div id="delete-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <h3>Confirm Delete</h3>
                        <p>Are you sure you want to delete this draft?</p>
                        <button id="confirm-delete-btn">Delete</button>
                        <button id="cancel-delete-btn">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <script type="module">
            import { auth, db, googleProvider, twitterProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword } from './firebase.js';
            import { saveDraft, updateDraft, getDrafts, deleteDraft, getDraft } from './drafts.js';
            import { onAuthStateChanged } from './firebase.js';

            // Make these objects available globally
            window.auth = auth;
            window.db = db;
            window.googleProvider = googleProvider;
            window.twitterProvider = twitterProvider;
            window.signInWithPopup = signInWithPopup;
            window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
            window.signInWithEmailAndPassword = signInWithEmailAndPassword;

            // Make draft functions available globally
            window.saveDraft = saveDraft;
            window.updateDraft = updateDraft;
            window.getDrafts = getDrafts;
            window.deleteDraft = deleteDraft;
            window.getDraft = getDraft;

            // Add this listener to persist auth state
            onAuthStateChanged((user) => {
                if (user) {
                    window.currentUser = user;
                    updateAuthUI();
                } else {
                    window.currentUser = null;
                    updateAuthUI();
                }
            });

            // Define your sign-in functions here
            window.handleGoogleSignIn = async function() {
                try {
                    showLoading(true);
                    console.log("Starting Google sign-in process");
                    const result = await signInWithPopup(auth, googleProvider);
                    console.log("Google sign-in successful", result);
                    window.currentUser = result.user;
                    clearAuthInputs();
                    console.log("Calling updateAuthUI");
                    updateAuthUI();
                } catch (error) {
                    console.error("Error signing in with Google:", error);
                    showError(getErrorMessage(error), 'auth');
                } finally {
                    showLoading(false);
                }
            }

            // Add this new function for Google Sign Up
            window.handleGoogleSignUp = async function() {
                try {
                    const result = await signInWithPopup(auth, googleProvider);
                    // Handle successful sign-up
                    window.currentUser = result.user;
                    clearAuthInputs();
                    updateAuthUI();
                    showError("Successfully signed up with Google!", 'auth');
                } catch (error) {
                    console.error("Error signing up with Google:", error);
                    showError(getErrorMessage(error), 'auth');
                }
            }

            window.handleTwitterSignIn = async function() {
                try {
                    showLoading(true);
                    const result = await signInWithPopup(auth, twitterProvider);
                    window.currentUser = result.user;
                    
                    // Log the entire result object to inspect its structure
                    console.log("Twitter sign-in result:", result);
                    console.log("User object:", result.user);
                    console.log("Additional user info:", result.additionalUserInfo);

                    // Try different possible locations for the Twitter handle
                    const twitterHandle = 
                        result.additionalUserInfo?.username ||
                        result.user?.reloadUserInfo?.screenName ||
                        result.user?.providerData[0]?.screenName ||
                        result.user?.displayName;

                    console.log("Retrieved Twitter handle:", twitterHandle);

                    if (twitterHandle) {
                        localStorage.setItem('twitterHandle', twitterHandle);
                    } else {
                        console.error("Could not retrieve Twitter handle");
                    }

                    clearAuthInputs();
                    updateAuthUI();
                } catch (error) {
                    console.error("Error signing in with Twitter:", error);
                    if (error.code === 'auth/popup-closed-by-user') {
                        showError("Twitter sign-in was cancelled. Please try again.", 'auth');
                    } else if (error.message.includes('Cross-Origin-Opener-Policy')) {
                        showError("There was an issue with the Twitter sign-in. Please try again or use another sign-in method.", 'auth');
                    } else {
                        showError(getErrorMessage(error), 'auth');
                    }
                } finally {
                    showLoading(false);
                }
            }

            // Other necessary functions...
        </script>
        <script>
            const DEFAULT_CHAR_LIMIT = 280;

            function showMessage(message, type = 'error', messageType = 'general') {
                console.log(`${type.charAt(0).toUpperCase() + type.slice(1)}:`, message);
                const messageElement = document.getElementById(messageType === 'auth' ? 'auth-error' : 'general-error');
                messageElement.textContent = message;
                messageElement.style.display = 'block';
                
                // Set color based on message type
                if (type === 'success') {
                    messageElement.style.color = '#28a745';
                    messageElement.style.backgroundColor = '#d4edda';
                    messageElement.style.border = '1px solid #c3e6cb';
                } else {
                    messageElement.style.color = '#721c24';
                    messageElement.style.backgroundColor = '#f8d7da';
                    messageElement.style.border = '1px solid #f5c6cb';
                }
                
                // Hide the message after 5 seconds
                setTimeout(() => {
                    messageElement.style.display = 'none';
                }, 5000);
            }

            const rateLimiter = {
                attempts: {},
                maxAttempts: 5,
                resetTime: 60000, // 1 minute

                checkLimit: function(action) {
                    const now = Date.now();
                    if (!this.attempts[action]) {
                        this.attempts[action] = { count: 1, lastAttempt: now };
                        return true;
                    }

                    if (now - this.attempts[action].lastAttempt > this.resetTime) {
                        this.attempts[action] = { count: 1, lastAttempt: now };
                        return true;
                    }

                    if (this.attempts[action].count >= this.maxAttempts) {
                        return false;
                    }

                    this.attempts[action].count++;
                    this.attempts[action].lastAttempt = now;
                    return true;
                }
            };

            async function handleSignUp() {
                if (!rateLimiter.checkLimit('signUp')) {
                    showError('Too many sign-up attempts. Please try again later.', 'auth');
                    return;
                }
                const email = document.getElementById('sign-up-email').value;
                const password = document.getElementById('sign-up-password').value;
                try {
                    showLoading(true);
                    const userCredential = await window.createUserWithEmailAndPassword(auth, email, password);
                    window.currentUser = userCredential.user;
                    clearAuthInputs();
                    updateAuthUI();
                } catch (error) {
                    console.error("Error signing up:", error);
                    showError(getErrorMessage(error), 'auth');
                } finally {
                    showLoading(false);
                }
            }

            async function handleSignIn(event) {
                event.preventDefault();
                if (!rateLimiter.checkLimit('signIn')) {
                    showError('Too many sign-in attempts. Please try again later.', 'auth');
                    return;
                }
                const email = document.getElementById('sign-in-email').value;
                const password = document.getElementById('sign-in-password').value;
                try {
                    showLoading(true);
                    console.log("Starting email sign-in process");
                    const userCredential = await window.signInWithEmailAndPassword(auth, email, password);
                    console.log("Email sign-in successful", userCredential);
                    window.currentUser = userCredential.user;
                    clearAuthInputs();
                    console.log("Calling updateAuthUI");
                    updateAuthUI();
                } catch (error) {
                    console.error("Error signing in:", error);
                    showError(getErrorMessage(error), 'auth');
                } finally {
                    showLoading(false);
                }
            }

            async function handleTwitterSignIn() {
                try {
                    showLoading(true);
                    const result = await signInWithPopup(auth, twitterProvider);
                    window.currentUser = result.user;
                    
                    // Log the entire result object to inspect its structure
                    console.log("Twitter sign-in result:", result);
                    console.log("User object:", result.user);
                    console.log("Additional user info:", result.additionalUserInfo);

                    // Try different possible locations for the Twitter handle
                    const twitterHandle = 
                        result.additionalUserInfo?.username ||
                        result.user?.reloadUserInfo?.screenName ||
                        result.user?.providerData[0]?.screenName ||
                        result.user?.displayName;

                    console.log("Retrieved Twitter handle:", twitterHandle);

                    if (twitterHandle) {
                        localStorage.setItem('twitterHandle', twitterHandle);
                    } else {
                        console.error("Could not retrieve Twitter handle");
                    }

                    clearAuthInputs();
                    updateAuthUI(); // This will now load drafts
                } catch (error) {
                    console.error("Error signing in with Twitter:", error);
                    if (error.code === 'auth/popup-closed-by-user') {
                        showError("Twitter sign-in was cancelled. Please try again.", 'auth');
                    } else if (error.message.includes('Cross-Origin-Opener-Policy')) {
                        showError("There was an issue with the Twitter sign-in. Please try again or use another sign-in method.", 'auth');
                    } else {
                        showError(getErrorMessage(error), 'auth');
                    }
                } finally {
                    showLoading(false);
                }
            }

            async function handleSignOut() {
                try {
                    showLoading(true);
                    
                    // Save the current draft before signing out
                    await saveDraftToFirestore();

                    await auth.signOut();
                    window.currentUser = null;
                    currentDraftId = null; // Reset the currentDraftId
                    localStorage.removeItem('twitterHandle'); // Clear the stored Twitter handle
                    clearAllDrafts();
                    clearAuthInputs();
                    updateAuthUI();
                    showError("Successfully signed out", 'auth');
                } catch (error) {
                    console.error("Error signing out:", error);
                    showError("Error signing out. Please try again!", 'auth');
                } finally {
                    showLoading(false);
                }
            }

            let isUpdatingAuthUI = false;
            let updateAuthUITimeout = null;

            const debouncedUpdateAuthUI = function() {
                if (isUpdatingAuthUI) return;
                
                if (updateAuthUITimeout) {
                    clearTimeout(updateAuthUITimeout);
                }

                updateAuthUITimeout = setTimeout(async function() {
                    isUpdatingAuthUI = true;
                    console.log("updateAuthUI: Start");
                    try {
                        const signUpForm = document.getElementById('sign-up-form');
                        const signInForm = document.getElementById('sign-in-form');
                        const forgotPasswordForm = document.getElementById('forgot-password-form');
                        const userInfo = document.getElementById('user-info');
                        const tweetThread = document.getElementById('tweet-thread');
                        const charLimitControl = document.querySelector('.char-limit-control');
                        const draftsList = document.getElementById('drafts-list');
                        const saveDraftBtn = document.getElementById('save-draft-btn');
                        const createNewBtn = document.getElementById('create-new-btn');

                        if (window.currentUser) {
                            console.log("updateAuthUI: User is logged in");
                            if (signUpForm) signUpForm.style.display = 'none';
                            if (signInForm) signInForm.style.display = 'none';
                            if (forgotPasswordForm) forgotPasswordForm.style.display = 'none';
                            if (userInfo) userInfo.style.display = 'block';
                            if (userInfo) {
                                const userEmail = document.getElementById('user-email');
                                if (userEmail) userEmail.textContent = window.currentUser.email;
                            }
                            if (tweetThread) tweetThread.style.display = 'block';
                            if (charLimitControl) charLimitControl.style.display = 'inline-block';
                            if (saveDraftBtn) saveDraftBtn.style.display = 'inline-block';
                            if (createNewBtn) createNewBtn.style.display = 'inline-block';
                            
                            clearAllDrafts();
                            window.currentDraftId = null;

                            await loadDrafts();

                            const tweetBoxes = document.querySelectorAll('.tweet-box');
                            if (tweetBoxes.length === 0) {
                                addTweet();
                            }
                        } else {
                            console.log("updateAuthUI: User is not logged in");
                            if (signUpForm) signUpForm.style.display = 'block';
                            if (signInForm) signInForm.style.display = 'block';
                            if (userInfo) userInfo.style.display = 'none';
                            if (tweetThread) tweetThread.style.display = 'none';
                            if (charLimitControl) charLimitControl.style.display = 'none';
                            if (draftsList) draftsList.style.display = 'none';
                            if (saveDraftBtn) saveDraftBtn.style.display = 'none';
                            if (createNewBtn) createNewBtn.style.display = 'none';
                            clearAllDrafts();
                        }
                    } catch (error) {
                        console.error("Error in updateAuthUI:", error);
                    } finally {
                        isUpdatingAuthUI = false;
                        console.log("updateAuthUI: End");
                    }
                }, 300);
            };

            function updateAuthUI() {
                debouncedUpdateAuthUI();
            }

            function clearAuthInputs() {
                document.getElementById('sign-up-email').value = '';
                document.getElementById('sign-up-password').value = '';
                document.getElementById('sign-in-email').value = '';
                document.getElementById('sign-in-password').value = '';
            }

            function updateCharCount(textarea) {
                const tweetBox = textarea.closest('.tweet-box');
                const urlCheckbox = tweetBox.querySelector('.url-checkbox input');
                const charCount = textarea.value.length + (urlCheckbox.checked ? 24 : 0);
                const charLimit = parseInt(textarea.dataset.limit);
                const countDisplay = tweetBox.querySelector('.character-count');
                countDisplay.textContent = `${charCount}/${charLimit}`;

                if (charCount === 0) {
                    textarea.style.backgroundColor = ''; // Neutral state
                } else if (charCount <= charLimit * 0.95) {
                    textarea.style.backgroundColor = 'rgba(144, 238, 144, 0.3)'; // Light green
                } else if (charCount <= charLimit) {
                    textarea.style.backgroundColor = 'rgba(255, 255, 0, 0.3)'; // Bright yellow
                } else {
                    textarea.style.backgroundColor = 'rgba(255, 0, 0, 0.2)'; // Bright red
                }
            }

            function addTweet(button) {
                console.log("addTweet: Start");
                const thread = document.getElementById('tweet-thread');
                const charLimit = document.getElementById('char-limit').value;
                console.log("addTweet: Creating tweet box");
                const tweetBox = document.createElement('div');
                tweetBox.className = 'tweet-box';
                
                const isFirstTweet = thread.children.length === 0;
                const placeholderText = isFirstTweet ? "Start here..." : "Continue draft...";
                
                console.log("addTweet: Setting tweet box HTML");
                tweetBox.innerHTML = `
                    <textarea oninput="updateCharCount(this)" data-limit="${charLimit}" placeholder="${placeholderText}"></textarea>
                    <div class="tweet-info">
                        <span class="character-count">0/${charLimit}</span>
                        <span class="thread-count"></span>
                        <label class="url-checkbox">
                            <input type="checkbox" onchange="updateCharCount(this.closest('.tweet-box').querySelector('textarea'))">
                            Adding a url for X?
                            <span class="tooltip-icon" data-tooltip="Checking this box will subtract\n24 characters to account\nfor adding a URL\nin a tweet.">i</span>
                        </label>
                    </div>
                    <div class="tweet-controls">
                        <div class="tweet-controls-left">
                            <button onclick="addTweet(this)">Add Tweet</button>
                            ${isFirstTweet ? '' : '<button class="remove-btn" onclick="removeTweet(this)">Remove</button>'}
                        </div>
                        <div class="tweet-controls-right">
                            <span class="copy-confirm">Copied!</span>
                            <button class="copy-btn" onclick="copyToClipboard(this.closest('.tweet-box').querySelector('textarea'))">Copy</button>
                        </div>
                    </div>
                    ${isFirstTweet ? '' : `
                    <div class="move-controls">
                        <button onclick="moveTweetUp(this)">▲</button>
                        <button onclick="moveTweetDown(this)">▼</button>
                    </div>
                    `}
                `;
                
                if (button) {
                    console.log("addTweet: Inserting after existing tweet");
                    const currentTweetBox = button.closest('.tweet-box');
                    currentTweetBox.insertAdjacentElement('afterend', tweetBox);
                } else {
                    console.log("addTweet: Appending to thread");
                    thread.appendChild(tweetBox);
                }
                
                console.log("addTweet: Updating thread counts");
                updateThreadCounts();
                console.log("addTweet: Toggling combine button");
                toggleCombineButton();
                console.log("addTweet: Toggling create new button");
                toggleCreateNewButton();
                
                console.log("addTweet: Focusing on new textarea");
                const newTextarea = tweetBox.querySelector('textarea');
                newTextarea.focus();
                console.log("addTweet: Completed");
            }

            function updateThreadCounts() {
                const thread = document.getElementById('tweet-thread');
                const tweetBoxes = thread.querySelectorAll('.tweet-box');
                const totalTweets = tweetBoxes.length;

                tweetBoxes.forEach((box, index) => {
                    const threadCountSpan = box.querySelector('.thread-count');
                    threadCountSpan.textContent = `🧵 ${index + 1}/${totalTweets}`;
                });
            }

            function removeTweet(button) {
                const tweetBox = button.closest('.tweet-box');
                const thread = document.getElementById('tweet-thread');
                
                if (thread.children.length > 1) {
                    tweetBox.remove();
                } else {
                    // If it's the last tweet, clear its content instead of removing it
                    const textarea = tweetBox.querySelector('textarea');
                    textarea.value = '';
                    updateCharCount(textarea);
                }
                
                updateThreadCounts();
                toggleCombineButton();
                toggleCreateNewButton();
            }

            function toggleCombineButton() {
                const tweetBoxes = document.querySelectorAll('.tweet-box');
                const combineButton = document.getElementById('combine-tweets-btn');
                combineButton.style.display = tweetBoxes.length > 1 ? 'inline-block' : 'none';
            }

            function toggleCreateNewButton() {
                const tweetBoxes = document.querySelectorAll('.tweet-box');
                const createNewBtn = document.getElementById('create-new-btn');
                createNewBtn.style.display = tweetBoxes.length > 0 ? 'inline-block' : 'none';
            }

            function copyToClipboard(element) {
                let textToCopy;
                if (typeof element === 'string') {
                    element = document.getElementById(element);
                }
                
                if (element.tagName === 'TEXTAREA') {
                    textToCopy = element.value;
                } else {
                    textToCopy = element.textContent;
                }
                
                navigator.clipboard.writeText(textToCopy).then(() => {
                    // Show the "Copied!" confirmation
                    const confirmSpan = element.closest('.tweet-controls-right').querySelector('.copy-confirm');
                    if (confirmSpan) {
                        confirmSpan.classList.add('show');
                        
                        // Hide the confirmation after 2 seconds
                        setTimeout(() => {
                            confirmSpan.classList.remove('show');
                        }, 2000);
                    }
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                });
            }

            function combinePosts() {
                const tweetContainers = document.querySelectorAll('.tweet-box');
                let combinedText = '';

                tweetContainers.forEach((container, index) => {
                    const textarea = container.querySelector('textarea');
                    if (textarea.value.trim() !== '') {
                        combinedText += textarea.value.trim();
                        if (index < tweetContainers.length - 1) {
                            combinedText += '\n\n';
                        }
                    }
                });

                const combinedTextarea = document.getElementById('combined-post');
                combinedTextarea.value = combinedText;
                autoResize(combinedTextarea);

                document.getElementById('combined-result').style.display = 'block';
            }

            function autoResize(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';
            }

            function toggleDarkMode() {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
            }

            async function createNewDraft() {
                if (!window.currentUser) return;

                try {
                    console.log("Creating new draft");
                    showLoading(true);
                    
                    // Save the current draft before creating a new one
                    if (window.currentDraftId) {
                        await saveDraftToFirestore();
                        showMessage('Previous draft saved', 'success', 'general');
                    }
                    
                    // Clear the current draft and create a new one
                    window.currentDraftId = null;
                    clearAllDrafts();
                    addTweet();
                    document.getElementById('char-limit').value = DEFAULT_CHAR_LIMIT;
                    document.getElementById('combine-tweets-btn').style.display = 'none';
                    document.getElementById('combined-result').style.display = 'none';
                    updateThreadCounts();
                    toggleCombineButton();
                    toggleCreateNewButton();

                    // Save the new empty draft
                    const content = getCurrentContent();
                    console.log("New draft content:", content);
                    window.currentDraftId = await window.saveDraft(window.currentUser.uid, content);
                    console.log("New draft created with ID:", window.currentDraftId);

                    await loadDrafts();
                    showMessage('New draft created!', 'success', 'general');
                } catch (error) {
                    console.error('Error creating new draft:', error);
                    showMessage('Failed to create new draft. Please try again.', 'error', 'general');
                } finally {
                    showLoading(false);
                }
            }

            async function saveDraftToFirestore() {
                if (!window.currentUser) {
                    console.log("No user logged in, can't save draft");
                    return;
                }

                const content = getCurrentContent();
                console.log("Current content:", content);

                // Only save if there's actual content
                if (content.tweets.some(tweet => tweet.trim() !== '')) {
                    try {
                        console.log("Attempting to save draft");
                        showLoading(true);
                        if (window.currentDraftId) {
                            console.log("Updating existing draft:", window.currentDraftId);
                            await window.updateDraft(window.currentUser.uid, window.currentDraftId, content);
                        } else {
                            console.log("Creating new draft");
                            window.currentDraftId = await window.saveDraft(window.currentUser.uid, content);
                            console.log("New draft created with ID:", window.currentDraftId);
                        }
                        await loadDrafts();
                        showMessage('Draft saved successfully!', 'success', 'general');
                    } catch (error) {
                        console.error('Error saving draft:', error);
                        showMessage('Failed to save draft. Please try again.', 'error', 'general');
                    } finally {
                        showLoading(false);
                    }
                } else {
                    console.log("No content to save");
                    // Removed the showMessage call for empty content
                }
            }

            // Ensure these functions are called when the buttons are clicked
            document.getElementById('save-draft-btn').onclick = saveDraftToFirestore;
            document.getElementById('create-new-btn').onclick = createNewDraft;

            // Add event listeners for page unload and refresh
            window.addEventListener('beforeunload', async (event) => {
                await saveDraftToFirestore();
            });

            async function loadDraft(draftId) {
                if (!window.currentUser) return;

                try {
                    // Save the current draft before loading a new one
                    await saveDraftToFirestore();

                    const draft = await window.getDraft(window.currentUser.uid, draftId);
                    console.log("Retrieved draft:", draft); // Log the retrieved draft

                    if (draft) {
                        clearAllDrafts();
                        document.getElementById('char-limit').value = draft.charLimit || DEFAULT_CHAR_LIMIT;

                        if (Array.isArray(draft.tweets)) {
                            draft.tweets.forEach((tweetContent, index) => {
                                if (index === 0) {
                                    const firstTweetBox = document.querySelector('.tweet-box');
                                    if (firstTweetBox) {
                                        const textarea = firstTweetBox.querySelector('textarea');
                                        textarea.value = tweetContent;
                                        updateCharCount(textarea);
                                    } else {
                                        addTweet();
                                        const newTextarea = document.querySelector('.tweet-box textarea');
                                        newTextarea.value = tweetContent;
                                        updateCharCount(newTextarea);
                                    }
                                } else {
                                    addTweet();
                                    const newTextarea = document.querySelector('.tweet-box:last-child textarea');
                                    newTextarea.value = tweetContent;
                                    updateCharCount(newTextarea);
                                }
                            });

                            const urlCheckboxes = document.querySelectorAll('.url-checkbox input');
                            if (Array.isArray(draft.urlBoxChecked)) {
                                draft.urlBoxChecked.forEach((isChecked, index) => {
                                    if (urlCheckboxes[index]) {
                                        urlCheckboxes[index].checked = isChecked;
                                    }
                                });
                            }

                            document.getElementById('combined-post').value = draft.combinedPost || '';
                            document.getElementById('combined-result').style.display = draft.combinedPost ? 'block' : 'none';

                            updateThreadCounts();
                            toggleCombineButton();
                            toggleCreateNewButton();
                        } else {
                            console.error("Draft tweets is not an array:", draft.tweets);
                            showMessage('Error loading draft: Invalid draft structure', 'error', 'general');
                        }
                    } else {
                        console.error("No draft found with ID:", draftId);
                        showMessage('Error loading draft: Draft not found', 'error', 'general');
                    }
                } catch (error) {
                    console.error('Error loading draft:', error);
                    showMessage('Failed to load draft. Please try again.', 'error', 'general');
                }
            }

            function resetTextareaState(textarea) {
                textarea.style.backgroundColor = ''; // Reset to default (neutral) state
                updateCharCount(textarea);
            }

            function moveTweetUp(button) {
                const tweetBox = button.closest('.tweet-box');
                const prevTweetBox = tweetBox.previousElementSibling;
                if (prevTweetBox) {
                    tweetBox.parentNode.insertBefore(tweetBox, prevTweetBox);
                    updateThreadCounts();
                }
            }

            function moveTweetDown(button) {
                const tweetBox = button.closest('.tweet-box');
                const nextTweetBox = tweetBox.nextElementSibling;
                if (nextTweetBox) {
                    tweetBox.parentNode.insertBefore(nextTweetBox, tweetBox);
                    updateThreadCounts();
                }
            }

            function clearAllDrafts() {
                console.log("clearAllDrafts: Start");
                const tweetThread = document.getElementById('tweet-thread');
                console.log("clearAllDrafts: Clearing tweet thread");
                tweetThread.innerHTML = ''; // Remove all tweet boxes
                console.log("clearAllDrafts: Clearing combined post");
                document.getElementById('combined-post').value = ''; // Clear combined post
                console.log("clearAllDrafts: Hiding combined result");
                document.getElementById('combined-result').style.display = 'none'; // Hide combined result
                console.log("clearAllDrafts: Resetting char limit");
                document.getElementById('char-limit').value = DEFAULT_CHAR_LIMIT; // Reset char limit to default
                console.log("clearAllDrafts: Toggling combine button");
                toggleCombineButton();
                console.log("clearAllDrafts: Toggling create new button");
                toggleCreateNewButton();
                console.log("clearAllDrafts: Completed");
            }

            function showForgotPasswordForm() {
                document.getElementById('sign-in-form').style.display = 'none';
                document.getElementById('forgot-password-form').style.display = 'block';
            }

            function showSignInForm() {
                document.getElementById('forgot-password-form').style.display = 'none';
                document.getElementById('sign-in-form').style.display = 'block';
            }

            async function handleForgotPassword() {
                const email = document.getElementById('reset-email').value;
                try {
                    await auth.sendPasswordResetEmail(email);
                    showMessage("Password reset email sent. Please check your inbox.", 'success', 'auth');
                    showSignInForm();
                } catch (error) {
                    showMessage("Error sending password reset email. Please try again.", 'error', 'auth');
                }
            }

            function getErrorMessage(error) {
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        return 'This email is already registered. Please sign in or use a different email.';
                    case 'auth/invalid-email':
                        return 'Invalid email address. Please check and try again.';
                    case 'auth/weak-password':
                        return 'Password is too weak. Please use a stronger password.';
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        return 'Invalid email or password. Please check and try again.';
                    default:
                        return 'An error occurred. Please try again later.';
                }
            }

            function showLoading(isLoading) {
                const loadingIndicator = document.getElementById('loading-indicator');
                if (isLoading) {
                    loadingIndicator.style.display = 'block';
                } else {
                    loadingIndicator.style.display = 'none';
                }
            }

            function loadGoogleSignInScript() {
                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/platform.js';
                script.async = true;
                script.defer = true;
                document.head.appendChild(script);
            }

            async function loadDrafts() {
                if (!window.currentUser) return;

                try {
                    const drafts = await window.getDrafts(window.currentUser.uid);
                    displayDraftsList(drafts);
                } catch (error) {
                    console.error('Error loading drafts:', error);
                    showMessage('Failed to load drafts. Please try again.', 'error', 'general');
                }
            }

            function displayDraftsList(drafts) {
                const draftsUl = document.getElementById('drafts-ul');
                draftsUl.innerHTML = '';

                // Sort drafts by timestamp, most recent first
                drafts.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());

                drafts.forEach((draft, index) => {
                    const li = document.createElement('li');
                    const firstTweet = draft.tweets && draft.tweets.length > 0 ? draft.tweets[0] : '';
                    const previewText = firstTweet.length > 30 ? firstTweet.substring(0, 30) + '...' : firstTweet;
                    const timeAgo = getTimeAgo(draft.timestamp.toDate());

                    li.innerHTML = `
                        <div class="draft-item">
                            <div class="draft-content">
                                <div class="draft-title">${previewText}</div>
                                <div class="draft-date">${timeAgo}</div>
                            </div>
                            <div class="draft-actions">
                                <button onclick="loadDraft('${draft.id}')" title="Load Draft">📄</button>
                                <button onclick="showDeleteConfirmation('${draft.id}')" title="Delete Draft">🗑️</button>
                            </div>
                        </div>
                    `;
                    draftsUl.appendChild(li);
                });

                document.querySelector('.drafts-sidebar').style.display = 'block';
            }

            function getTimeAgo(date) {
                const now = new Date();
                const diffInSeconds = Math.floor((now - date) / 1000);
                const diffInMinutes = Math.floor(diffInSeconds / 60);
                const diffInHours = Math.floor(diffInMinutes / 60);
                const diffInDays = Math.floor(diffInHours / 24);
                const diffInYears = Math.floor(diffInDays / 365);

                if (diffInYears > 0) {
                    return `${diffInYears} ${diffInYears === 1 ? 'year' : 'years'} ago`;
                } else if (diffInDays > 0) {
                    return `${diffInDays} ${diffInDays === 1 ? 'day' : 'days'} ago`;
                } else if (diffInHours > 0) {
                    return `${diffInHours} ${diffInHours === 1 ? 'hour' : 'hours'} ago`;
                } else if (diffInMinutes > 0) {
                    return `${diffInMinutes} min ago`;
                } else {
                    return `${diffInSeconds} sec ago`;
                }
            }

            async function loadDraft(draftId) {
                if (!window.currentUser) return;

                try {
                    // Save the current draft before loading a new one
                    await saveDraftToFirestore();

                    const draft = await window.getDraft(window.currentUser.uid, draftId);
                    console.log("Retrieved draft:", draft); // Log the retrieved draft

                    if (draft) {
                        clearAllDrafts();
                        document.getElementById('char-limit').value = draft.charLimit || DEFAULT_CHAR_LIMIT;

                        if (Array.isArray(draft.tweets)) {
                            draft.tweets.forEach((tweetContent, index) => {
                                if (index === 0) {
                                    const firstTweetBox = document.querySelector('.tweet-box');
                                    if (firstTweetBox) {
                                        const textarea = firstTweetBox.querySelector('textarea');
                                        textarea.value = tweetContent;
                                        updateCharCount(textarea);
                                    } else {
                                        addTweet();
                                        const newTextarea = document.querySelector('.tweet-box textarea');
                                        newTextarea.value = tweetContent;
                                        updateCharCount(newTextarea);
                                    }
                                } else {
                                    addTweet();
                                    const newTextarea = document.querySelector('.tweet-box:last-child textarea');
                                    newTextarea.value = tweetContent;
                                    updateCharCount(newTextarea);
                                }
                            });

                            const urlCheckboxes = document.querySelectorAll('.url-checkbox input');
                            if (Array.isArray(draft.urlBoxChecked)) {
                                draft.urlBoxChecked.forEach((isChecked, index) => {
                                    if (urlCheckboxes[index]) {
                                        urlCheckboxes[index].checked = isChecked;
                                    }
                                });
                            }

                            document.getElementById('combined-post').value = draft.combinedPost || '';
                            document.getElementById('combined-result').style.display = draft.combinedPost ? 'block' : 'none';

                            updateThreadCounts();
                            toggleCombineButton();
                            toggleCreateNewButton();
                        } else {
                            console.error("Draft tweets is not an array:", draft.tweets);
                            showMessage('Error loading draft: Invalid draft structure', 'error', 'general');
                        }
                    } else {
                        console.error("No draft found with ID:", draftId);
                        showMessage('Error loading draft: Draft not found', 'error', 'general');
                    }
                } catch (error) {
                    console.error('Error loading draft:', error);
                    showMessage('Failed to load draft. Please try again.', 'error', 'general');
                }
            }

            async function saveDraftToFirestore() {
                if (!window.currentUser) {
                    console.log("No user logged in, can't save draft");
                    return;
                }

                const content = getCurrentContent();
                console.log("Current content:", content);

                // Only save if there's actual content
                if (content.tweets.some(tweet => tweet.trim() !== '')) {
                    try {
                        console.log("Attempting to save draft");
                        showLoading(true);
                        if (window.currentDraftId) {
                            console.log("Updating existing draft:", window.currentDraftId);
                            await window.updateDraft(window.currentUser.uid, window.currentDraftId, content);
                        } else {
                            console.log("Creating new draft");
                            window.currentDraftId = await window.saveDraft(window.currentUser.uid, content);
                            console.log("New draft created with ID:", window.currentDraftId);
                        }
                        await loadDrafts();
                        showMessage('Draft saved successfully!', 'success', 'general');
                    } catch (error) {
                        console.error('Error saving draft:', error);
                        showMessage('Failed to save draft. Please try again.', 'error', 'general');
                    } finally {
                        showLoading(false);
                    }
                } else {
                    console.log("No content to save");
                    // Removed the showMessage call for empty content
                }
            }

            async function updateDraftInFirestore(draftId) {
                if (!window.currentUser) return;

                const content = getCurrentContent();
                try {
                    await window.updateDraft(window.currentUser.uid, draftId, content);
                    showMessage('Draft updated successfully!', 'success', 'general');
                    loadDrafts(); // Reload the drafts list
                } catch (error) {
                    console.error('Error updating draft:', error);
                    showMessage('Failed to update draft. Please try again.', 'error', 'general');
                }
            }

            function getCurrentContent() {
                const tweetBoxes = document.querySelectorAll('.tweet-box');
                const tweets = Array.from(tweetBoxes).map(box => box.querySelector('textarea').value);
                const urlBoxChecked = Array.from(tweetBoxes).map(box => box.querySelector('.url-checkbox input').checked);
                const charLimit = document.getElementById('char-limit').value;
                const combinedPost = document.getElementById('combined-post').value;

                const content = {
                    tweets,
                    urlBoxChecked,
                    charLimit,
                    combinedPost
                };

                console.log("Current content:", content);
                return content;
            }

            async function createNewDraft() {
                if (!window.currentUser) {
                    console.log("No user logged in, can't create new draft");
                    return;
                }

                try {
                    console.log("Creating new draft");
                    showLoading(true);
                    
                    // Save the current draft before creating a new one
                    if (window.currentDraftId) {
                        await saveDraftToFirestore();
                        showMessage('Previous draft saved', 'success', 'general');
                    }
                    
                    // Clear the current draft and create a new one
                    window.currentDraftId = null;
                    clearAllDrafts();
                    addTweet();
                    document.getElementById('char-limit').value = DEFAULT_CHAR_LIMIT;
                    document.getElementById('combine-tweets-btn').style.display = 'none';
                    document.getElementById('combined-result').style.display = 'none';
                    updateThreadCounts();
                    toggleCombineButton();
                    toggleCreateNewButton();

                    // Save the new empty draft
                    const content = getCurrentContent();
                    console.log("New draft content:", content);
                    window.currentDraftId = await window.saveDraft(window.currentUser.uid, content);
                    console.log("New draft created with ID:", window.currentDraftId);

                    await loadDrafts();
                    showMessage('New draft created!', 'success', 'general');
                } catch (error) {
                    console.error('Error creating new draft:', error);
                    showMessage('Failed to create new draft. Please try again.', 'error', 'general');
                } finally {
                    showLoading(false);
                }
            }

            async function deleteDraftWithConfirmation(draftId) {
                showDeleteConfirmation(draftId);
            }

            function showDeleteConfirmation(draftId) {
                const modal = document.getElementById('delete-modal');
                const confirmBtn = document.getElementById('confirm-delete-btn');
                const cancelBtn = document.getElementById('cancel-delete-btn');

                modal.style.display = 'block';

                confirmBtn.onclick = async () => {
                    modal.style.display = 'none';
                    try {
                        await window.deleteDraft(window.currentUser.uid, draftId);
                        showMessage('Draft deleted successfully!', 'success', 'general');
                        loadDrafts(); // Reload the drafts list
                    } catch (error) {
                        console.error('Error deleting draft:', error);
                        showMessage('Failed to delete draft. Please try again.', 'error', 'general');
                    }
                };

                cancelBtn.onclick = () => {
                    modal.style.display = 'none';
                };

                // Close the modal if clicked outside
                window.onclick = (event) => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                };
            }

            // Initialize the page with default settings
            document.addEventListener('DOMContentLoaded', function() {
                console.log("Page loaded");
                document.getElementById('char-limit').value = DEFAULT_CHAR_LIMIT;
                document.getElementById('create-new-btn').style.display = 'none';
                document.querySelector('.char-limit-control').style.display = 'none';
                document.getElementById('combine-tweets-btn').style.display = 'none';
                
                if (localStorage.getItem('darkMode') === 'true') {
                    document.body.classList.add('dark-mode');
                    document.getElementById('dark-mode-switch').checked = true;
                }

                console.log("Calling updateAuthUI");
                updateAuthUI();
            });
        </script>
    </div>
</body>
</html>